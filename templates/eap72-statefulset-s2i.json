{
    "apiVersion": "template.openshift.io/v1",
    "kind": "Template",
    "metadata": {
        "annotations": {
            "description": "How the EJB3 remoting works with statefulset",
            "iconClass": "icon-eap",
            "openshift.io/display-name": "EJB3 remoting with statefulset setup",
            "tags": "eap,javaee,java,jboss"
        },
        "creationTimestamp": "2019-03-22T10:53:32Z",
        "name": "statefulset-ejb3-remoting",
        "namespace": "openshift",
        "resourceVersion": "71943",
        "selfLink": "/apis/template.openshift.io/v1/namespaces/openshift/templates/statefulset-ejb3-remoting",
        "uid": "bc3ad00d-4c90-11e9-b399-525400277f96"
    },
    "objects": [
        {
            "apiVersion": "v1",
            "kind": "Service",
            "metadata": {
                "annotations": {
                    "description": "Service for client"
                },
                "labels": {
                    "application": "${CLIENT_APPLICATION}"
                },
                "name": "${CLIENT_APPLICATION}"
            },
            "spec": {
                "clusterIP": "None",
                "ports": [
                    {
                        "name": "eap-http",
                        "port": 8080,
                        "targetPort": 8080
                    }
                ],
                "selector": {
                    "application": "${CLIENT_APPLICATION}"
                }
            }
        },
        {
            "apiVersion": "v1",
            "kind": "Service",
            "metadata": {
                "annotations": {
                    "description": "Service for server"
                },
                "labels": {
                    "application": "${SERVER_APPLICATION}"
                },
                "name": "${SERVER_APPLICATION}"
            },
            "spec": {
                "clusterIP": "None",
                "ports": [
                    {
                        "name": "eap-http",
                        "port": 8080,
                        "targetPort": 8080
                    }
                ],
                "selector": {
                    "application": "${SERVER_APPLICATION}"
                }
            }
        },
        {
            "apiVersion": "v1",
            "id": "${CLIENT_APPLICATION}-http",
            "kind": "Route",
            "metadata": {
                "annotations": {
                    "description": "Route for the tx-client application http service."
                },
                "labels": {
                    "application": "${CLIENT_APPLICATION}"
                },
                "name": "${CLIENT_APPLICATION}"
            },
            "spec": {
                "to": {
                    "name": "${CLIENT_APPLICATION}"
                }
            }
        },
        {
            "apiVersion": "apps/v1",
            "kind": "StatefulSet",
            "metadata": {
                "application": "${CLIENT_APPLICATION}",
                "name": "${CLIENT_APPLICATION}"
            },
            "spec": {
                "replicas": 1,
                "selector": {
                    "matchLabels": {
                        "application": "${CLIENT_APPLICATION}"
                    }
                },
                "serviceName": "${CLIENT_APPLICATION}",
                "template": {
                    "metadata": {
                        "annotations": {
                            "alpha.image.policy.openshift.io/resolve-names": "*"
                        },
                        "labels": {
                            "application": "${CLIENT_APPLICATION}"
                        },
                        "name": "${CLIENT_APPLICATION}"
                    },
                    "spec": {
                        "containers": [
                            {
                                "env": [
                                    {
                                        "name": "OPENSHIFT_KUBE_PING_NAMESPACE",
                                        "value": "${KUBE_PING_NAMESPACE}"
                                    },
                                    {
                                        "name": "OPENSHIFT_KUBE_PING_LABELS",
                                        "value": "application=${CLIENT_APPLICATION}"
                                    },
                                    {
                                        "name": "JAVA_OPTS_APPEND",
                                        "value": "-Dtx.server.host=${SERVER_APPLICATION} -Djboss.default.multicast.address=230.0.0.5"
                                    },
                                    {
                                        "name": "SCRIPT_DEBUG",
                                        "value": "${SCRIPT_DEBUG}"
                                    }
                                ],
                                "image": "${CLIENT_APPLICATION}",
                                "livenessProbe": {
                                    "exec": {
                                        "command": [
                                            "/bin/bash",
                                            "-c",
                                            "/opt/eap/bin/livenessProbe.sh"
                                        ]
                                    },
                                    "initialDelaySeconds": 60
                                },
                                "name": "tx-client",
                                "ports": [
                                    {
                                        "containerPort": 8778,
                                        "name": "jolokia",
                                        "protocol": "TCP"
                                    },
                                    {
                                        "containerPort": 8080,
                                        "name": "http",
                                        "protocol": "TCP"
                                    },
                                    {
                                        "containerPort": 8888,
                                        "name": "ping",
                                        "protocol": "TCP"
                                    }
                                ],
                                "readinessProbe": {
                                    "exec": {
                                        "command": [
                                            "/bin/bash",
                                            "-c",
                                            "/opt/eap/bin/readinessProbe.sh"
                                        ]
                                    },
                                    "initialDelaySeconds": 10
                                },
                                "resources": {
                                    "limits": {
                                        "memory": "${MEMORY_LIMIT}"
                                    }
                                },
                                "volumeMounts": [
                                    {
                                        "mountPath": "/opt/eap/standalone/data",
                                        "name": "clientdata"
                                    }
                                ]
                            }
                        ]
                    }
                },
                "volumeClaimTemplates": [
                    {
                        "metadata": {
                            "name": "clientdata"
                        },
                        "spec": {
                            "accessModes": [
                                "ReadWriteOnce"
                            ],
                            "resources": {
                                "requests": {
                                    "storage": "${VOLUME_CAPACITY}"
                                }
                            }
                        }
                    }
                ]
            }
        },
        {
            "apiVersion": "v1",
            "kind": "ImageStream",
            "metadata": {
                "labels": {
                    "application": "${CLIENT_APPLICATION}"
                },
                "name": "${CLIENT_APPLICATION}"
            }
        },
        {
            "apiVersion": "v1",
            "kind": "BuildConfig",
            "metadata": {
                "labels": {
                    "application": "${CLIENT_APPLICATION}"
                },
                "name": "${CLIENT_APPLICATION}"
            },
            "spec": {
                "output": {
                    "to": {
                        "kind": "ImageStreamTag",
                        "name": "${CLIENT_APPLICATION}:latest"
                    }
                },
                "source": {
                    "contextDir": "${CLIENT_CONTEXT_DIR}",
                    "git": {
                        "ref": "${SOURCE_REPOSITORY_REF}",
                        "uri": "${SOURCE_REPOSITORY_URL}"
                    },
                    "type": "Git"
                },
                "strategy": {
                    "sourceStrategy": {
                        "env": [
                            {
                                "name": "MAVEN_MIRROR_URL",
                                "value": "${MAVEN_MIRROR_URL}"
                            },
                            {
                                "name": "MAVEN_ARGS_APPEND",
                                "value": "${MAVEN_ARGS_APPEND}"
                            },
                            {
                                "name": "ARTIFACT_DIR",
                                "value": "${ARTIFACT_DIR}"
                            }
                        ],
                        "forcePull": true,
                        "from": {
                            "kind": "ImageStreamTag",
                            "name": "eap-image-stream:latest",
                            "namespace": "${IMAGE_STREAM_NAMESPACE}"
                        },
                        "incremental": true
                    },
                    "type": "Source"
                },
                "triggers": [
                    {
                        "github": {
                            "secret": "${GITHUB_WEBHOOK_SECRET}"
                        },
                        "type": "GitHub"
                    },
                    {
                        "generic": {
                            "secret": "${GENERIC_WEBHOOK_SECRET}"
                        },
                        "type": "Generic"
                    },
                    {
                        "imageChange": {},
                        "type": "ImageChange"
                    },
                    {
                        "type": "ConfigChange"
                    }
                ]
            }
        },
        {
            "apiVersion": "apps/v1",
            "kind": "StatefulSet",
            "metadata": {
                "application": "${SERVER_APPLICATION}",
                "name": "${SERVER_APPLICATION}"
            },
            "spec": {
                "replicas": 2,
                "selector": {
                    "matchLabels": {
                        "application": "${SERVER_APPLICATION}"
                    }
                },
                "serviceName": "${SERVER_APPLICATION}",
                "template": {
                    "metadata": {
                        "annotations": {
                            "alpha.image.policy.openshift.io/resolve-names": "*"
                        },
                        "labels": {
                            "application": "${SERVER_APPLICATION}"
                        },
                        "name": "${SERVER_APPLICATION}"
                    },
                    "spec": {
                        "containers": [
                            {
                                "env": [
                                    {
                                        "name": "OPENSHIFT_KUBE_PING_NAMESPACE",
                                        "value": "${KUBE_PING_NAMESPACE}"
                                    },
                                    {
                                        "name": "OPENSHIFT_KUBE_PING_LABELS",
                                        "value": "application=${SERVER_APPLICATION}"
                                    },
                                    {
                                        "name": "JAVA_OPTS_APPEND",
                                        "value": "-Djboss.default.multicast.address=230.0.0.6"
                                    },
                                    {
                                        "name": "SCRIPT_DEBUG",
                                        "value": "${SCRIPT_DEBUG}"
                                    }
                                ],
                                "image": "${SERVER_APPLICATION}",
                                "livenessProbe": {
                                    "exec": {
                                        "command": [
                                            "/bin/bash",
                                            "-c",
                                            "/opt/eap/bin/livenessProbe.sh"
                                        ]
                                    },
                                    "initialDelaySeconds": 60
                                },
                                "name": "tx-server",
                                "ports": [
                                    {
                                        "containerPort": 8778,
                                        "name": "jolokia",
                                        "protocol": "TCP"
                                    },
                                    {
                                        "containerPort": 8080,
                                        "name": "http",
                                        "protocol": "TCP"
                                    },
                                    {
                                        "containerPort": 8888,
                                        "name": "ping",
                                        "protocol": "TCP"
                                    }
                                ],
                                "readinessProbe": {
                                    "exec": {
                                        "command": [
                                            "/bin/bash",
                                            "-c",
                                            "/opt/eap/bin/readinessProbe.sh"
                                        ]
                                    },
                                    "initialDelaySeconds": 10
                                },
                                "resources": {
                                    "limits": {
                                        "memory": "${MEMORY_LIMIT}"
                                    }
                                },
                                "volumeMounts": [
                                    {
                                        "mountPath": "/opt/eap/standalone/data",
                                        "name": "serverdata"
                                    }
                                ]
                            }
                        ]
                    }
                },
                "volumeClaimTemplates": [
                    {
                        "metadata": {
                            "name": "serverdata"
                        },
                        "spec": {
                            "accessModes": [
                                "ReadWriteOnce"
                            ],
                            "resources": {
                                "requests": {
                                    "storage": "${VOLUME_CAPACITY}"
                                }
                            }
                        }
                    }
                ]
            }
        },
        {
            "apiVersion": "v1",
            "kind": "ImageStream",
            "metadata": {
                "labels": {
                    "application": "${SERVER_APPLICATION}"
                },
                "name": "${SERVER_APPLICATION}"
            }
        },
        {
            "apiVersion": "v1",
            "kind": "BuildConfig",
            "metadata": {
                "labels": {
                    "application": "${SERVER_APPLICATION}"
                },
                "name": "${SERVER_APPLICATION}"
            },
            "spec": {
                "output": {
                    "to": {
                        "kind": "ImageStreamTag",
                        "name": "${SERVER_APPLICATION}:latest"
                    }
                },
                "source": {
                    "contextDir": "${SERVER_CONTEXT_DIR}",
                    "git": {
                        "ref": "${SOURCE_REPOSITORY_REF}",
                        "uri": "${SOURCE_REPOSITORY_URL}"
                    },
                    "type": "Git"
                },
                "strategy": {
                    "sourceStrategy": {
                        "env": [
                            {
                                "name": "MAVEN_MIRROR_URL",
                                "value": "${MAVEN_MIRROR_URL}"
                            },
                            {
                                "name": "MAVEN_ARGS_APPEND",
                                "value": "${MAVEN_ARGS_APPEND}"
                            },
                            {
                                "name": "ARTIFACT_DIR",
                                "value": "${ARTIFACT_DIR}"
                            }
                        ],
                        "forcePull": true,
                        "from": {
                            "kind": "ImageStreamTag",
                            "name": "eap-image-stream:latest",
                            "namespace": "${IMAGE_STREAM_NAMESPACE}"
                        },
                        "incremental": true
                    },
                    "type": "Source"
                },
                "triggers": [
                    {
                        "github": {
                            "secret": "${GITHUB_WEBHOOK_SECRET}"
                        },
                        "type": "GitHub"
                    },
                    {
                        "generic": {
                            "secret": "${GENERIC_WEBHOOK_SECRET}"
                        },
                        "type": "Generic"
                    },
                    {
                        "imageChange": {},
                        "type": "ImageChange"
                    },
                    {
                        "type": "ConfigChange"
                    }
                ]
            }
        },
        {
            "apiVersion": "v1",
            "kind": "ImageStream",
            "metadata": {
                "annotations": {
                    "openshift.io/display-name": "JBossEAP"
                },
                "name": "eap-image-stream"
            },
            "spec": {
                "tags": [
                    {
                        "from": {
                            "kind": "DockerImage",
                            "name": "registry.access.redhat.com/jboss-eap-7/eap71-openshift:latest"
                        },
                        "name": "latest"
                    }
                ]
            }
        },
        {
            "apiVersion": "v1",
            "kind": "Role",
            "metadata": {
                "name": "pods-listing"
            },
            "rules": [
                {
                    "apiGroups": null,
                    "attributeRestrictions": null,
                    "resources": [
                        "pods"
                    ],
                    "verbs": [
                        "list"
                    ]
                }
            ]
        },
        {
            "apiVersion": "v1",
            "kind": "RoleBinding",
            "metadata": {
                "annotations": {
                    "description": "Role binding for the default service account"
                },
                "name": "claim-pod-listing-to-default"
            },
            "roleRef": {
                "kind": "Role",
                "name": "pods-listing",
                "namespace": "${IMAGE_STREAM_NAMESPACE}"
            },
            "subjects": [
                {
                    "kind": "ServiceAccount",
                    "name": "default",
                    "namespace": "${IMAGE_STREAM_NAMESPACE}"
                }
            ]
        }
    ],
    "parameters": [
        {
            "displayName": "Client application name",
            "name": "CLIENT_APPLICATION",
            "required": true,
            "value": "tx-client"
        },
        {
            "description": "Path within Git project to build; empty for root project directory.",
            "displayName": "Context Directory",
            "name": "CLIENT_CONTEXT_DIR",
            "value": "tx-client"
        },
        {
            "displayName": "Server application name",
            "name": "SERVER_APPLICATION",
            "required": true,
            "value": "tx-server"
        },
        {
            "description": "Path within Git project to build; empty for root project directory.",
            "displayName": "Context Directory",
            "name": "SERVER_CONTEXT_DIR",
            "value": "tx-server"
        },
        {
            "description": "What is namespace for Kube ping protocol, usually the project name of the deployments.",
            "displayName": "Namespace for Kube ping protocol",
            "name": "KUBE_PING_NAMESPACE",
            "value": "myproject"
        },
        {
            "displayName": "Container memory limit",
            "name": "MEMORY_LIMIT",
            "value": "1Gi"
        },
        {
            "displayName": "Capacity of the volume of the statefulset",
            "name": "VOLUME_CAPACITY",
            "value": "1Gi"
        },
        {
            "description": "Git source URI for application",
            "displayName": "Git Repository URL",
            "name": "SOURCE_REPOSITORY_URL",
            "required": true,
            "value": "https://github.com/ochaloup/openshift-tx.git"
        },
        {
            "description": "Git branch/tag reference",
            "displayName": "Git Reference",
            "name": "SOURCE_REPOSITORY_REF",
            "value": "eap71-statefulset-call-error"
        },
        {
            "description": "Additional directories from which to install.",
            "displayName": "Custom install directories (see documentation).",
            "name": "CUSTOM_INSTALL_DIRECTORIES",
            "value": "extensions/*"
        },
        {
            "description": "Maven mirror to use for S2I builds",
            "displayName": "Maven mirror URL",
            "name": "MAVEN_MIRROR_URL"
        },
        {
            "description": "Maven additional arguments to use for S2I builds",
            "displayName": "Maven Additional Arguments",
            "name": "MAVEN_ARGS_APPEND"
        },
        {
            "description": "List of directories from which archives will be copied into the deployment folder. If unspecified, all archives in /target will be copied.",
            "name": "ARTIFACT_DIR"
        },
        {
            "description": "Default is without any namespace. Middleware goes usually to openshift namespace. It is where EAP image is searched at.",
            "displayName": "ImageStream Namespace",
            "name": "IMAGE_STREAM_NAMESPACE",
            "value": "openshift"
        },
        {
            "description": "GitHub trigger secret",
            "displayName": "Github Webhook Secret",
            "from": "[a-zA-Z0-9]{8}",
            "generate": "expression",
            "name": "GITHUB_WEBHOOK_SECRET",
            "required": true
        },
        {
            "description": "Generic build trigger secret",
            "displayName": "Generic Webhook Secret",
            "from": "[a-zA-Z0-9]{8}",
            "generate": "expression",
            "name": "GENERIC_WEBHOOK_SECRET",
            "required": true
        },
        {
            "description": "Running OpenShift EAP scripts with set -x",
            "name": "SCRIPT_DEBUG",
            "value": "false"
        }
    ]
}
